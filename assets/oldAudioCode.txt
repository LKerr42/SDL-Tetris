SDL_AudioStream *stream;
SDL_AudioSpec AudioSpec;

void initaliseAudioFile(sound *wavFile, char path[]) {
    SDL_SetHint(SDL_HINT_AUDIO_DEVICE_SAMPLE_FRAMES, "10");     // request ~10ms output buffer

    SDL_AudioSpec AudioSpec = {0};
    AudioSpec.format = SDL_AUDIO_F32;
    AudioSpec.channels = 2;
    AudioSpec.freq = 480;

    SDL_AudioDeviceID dev = SDL_OpenAudioDevice(
        SDL_AUDIO_DEVICE_DEFAULT_PLAYBACK,
        &AudioSpec
    );

    strcpy(wavFile -> source, path);
    wavFile -> audio_buff = NULL;
    wavFile -> audio_len = 0;
    wavFile -> cursor = 0;
    wavFile -> playing = 0;
    if (!SDL_LoadWAV(wavFile->source, &AudioSpec, &wavFile->audio_buff, &wavFile->audio_len)) {
        SDL_Log("SDL_LoadWAV failed: %s", SDL_GetError());
    }

    stream = SDL_OpenAudioDeviceStream(
        dev,
        &AudioSpec,
        NULL,
        NULL
    );
    if (!stream) {
        SDL_Log("SDL_OpenAudioDeviceStream failed: %s", SDL_GetError());
    }
    SDL_SetAudioStreamFormat(stream, NULL, &AudioSpec); // ensure no resampling
    SDL_ResumeAudioStreamDevice(stream);
}

void audioTick(sound *s) {
    if (!s -> playing) return;

    const Uint32 chunk = AudioSpec.freq * AudioSpec.channels * sizeof(float);

    Uint32 remaining = s->audio_len - s->cursor;
    Uint32 bytesToPush = (remaining > chunk) ? chunk : remaining;

    SDL_PutAudioStreamData(stream, s->audio_buff + s->cursor, bytesToPush);

    s->cursor += bytesToPush;
    if (s->cursor >= s->audio_len) {
        s->playing = 0;
    }
}

void playSound(sound *s) {
    s->cursor = 0;
    s->playing = 1;
    SDL_FlushAudioStream(stream);
}

void debug_print_audio_latency() {
    int bytesQueued = SDL_GetAudioStreamQueued(stream);
    if (bytesQueued < 0) {
        SDL_Log("SDL_GetAudioStreamQueued failed: %s", SDL_GetError());
        return;
    }

    // size of 1 frame = channels * sizeof(float)
    int frameSize = 2 * sizeof(float);  
    int framesQueued = bytesQueued / frameSize;

    // convert frames into milliseconds based on device frequency
    int ms = (int)((framesQueued * 1000.0f) / 48000.0f);

    SDL_Log("Audio queued = %d bytes (~%d ms latency)", bytesQueued, ms);
}

void playWAV(sound *wavFile) {
    SDL_FlushAudioStream(stream); // clears ANY pending audio

    // Push sound immediately (no queue buildup)
    if (!SDL_PutAudioStreamData(stream, wavFile->audio_buff, wavFile->audio_len)) {
        SDL_Log("SDL_PutAudioStreamData failed: %s", SDL_GetError());
    }
    //printf("Sound %s played\n", wavFile->source);
    debug_print_audio_latency();
}